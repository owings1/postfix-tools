#!/bin/bash

set -e

source "$(dirname "$0")/helpers/common.sh"

srcdir="$CONFIG_REPO"
thisdir="$(abs `dirname "$0"`)"
confdir=`postconf -h config_directory`
outdir="$confdir/history/$(date_path)"
helpers="$thisdir/helpers"

echo "Writing update to $outdir"
mkdir -p "$outdir/tmp"
postconf -n > "$outdir/tmp/main.old"
postconf -n -c "$srcdir" > "$outdir/tmp/main.src"
"$helpers/config_diff" "$outdir/tmp/main.old" "$outdir/tmp/main.src" "$outdir"
"$helpers/files_diff" "$confdir" "$outdir"

echo "Appling reconfigure"
ls "$outdir"/*.commit.sh 2>/dev/null | while read f; do
    echo "[apply] $(basename "$f")"
    bash "$f"
done

echo "Marking as latest"
pushdq "$outdir/.."
rm -f latest
ln -s "$(basename "$outdir")" latest
popdq

echo "Update postmaps"
"$helpers/post_maps" "$confdir"

postfix_reload

if is_dovecot ; then
    echo "Updating dovecot config"
    ischange=
    pushdq "$srcdir"
    opts="--preserve=timestamps -bv --suffix=.$(date_path)"
    if ! md5cmp dovecot.conf /etc/dovecot/dovecot.conf ; then
        cp $opts dovecot.conf /etc/dovecot
        ischange=true
    fi
    ls 10-*.conf 2>/dev/null | while read f; do
        if ! md5cmp "$f" "/etc/dovecot/conf.d/$f" ; then
            cp $opts "$f" "/etc/dovecot/conf.d/$f"
            ischange=true
        fi
    done
    popdq
    if [[ ! -z "$ischange" ]]; then
        dovecot_reload
    fi
fi
            