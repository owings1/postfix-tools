#!/bin/bash
source "$(dirname "$0")/helpers/common.sh"
shopt -s expand_aliases
alias logger="/usr/bin/logger -t reconfigure"

if [[ -t 0 ]] && [[ -z "$LOGONLY" ]]; then
    alias write="echo"
else
    alias write="true"
fi

log() {
    local fdn msg pfx
    local priority="$1"
    if [[ "$priority" = err ]]; then
        fdn=2
        pfx="${cRed}ERROR${cReset} "
    else
        pfx="$cGreen$uCaret$cReset "
        fdn=1
    fi
    while read msg ; do
        write "$pfx$msg" >&$fdn
        logger -p "$priority" "$msg"
    done
}

run() {
    {
        _run 2>&1 1>&3 3>&- | log err
    } 3>&1 1>&2 | log notice
}

_run() {
    set -e
    local srcdir="$CONFIG_REPO"
    local thisdir="$(abs `dirname "$0"`)"
    local confdir=`postconf -h config_directory`
    local outdir="$confdir/history/$(date_path)"
    local builddir="$outdir/build"
    local helpers="$thisdir/helpers"
    local static="$thisdir/static"
    local builddirq="$(printf '%q' "$builddir")"

    echo "Writing update to $outdir"
    mkdir -p "$builddir"
    pushdq "$builddir"
    # postfix main.cf
    postconf -n | grep -v '^config_directory =' > main.cf.old
    postconf -n -c "$srcdir" | grep -v '^config_directory =' > main.cf.new
    if ! md5cmp master.cf.old master.cf.new ; then
        "$helpers/postfixmain_diff" main.cf.old main.cf.new .
    fi

    make_file_actions() {
        local oldfile="$1"
        local newfile="$2"
        local dest="$3"
        local title="$4"
        local apfile="$title.apply.sh"
        local rvfile="$title.revert.sh"
        diff "$oldfile" "$newfile" | sed 's/^/# /' >> "$apfile"
        diff "$newfile" "$oldfile" | sed 's/^/# /' >> "$rvfile"
        echo "cd $builddirq && install -v -p -m 0644 \\" | teeq -a "$apfile" "$rvfile"
        echo "    $newfile $dest" >> "$apfile"
        echo "    $oldfile $dest" >> "$rvfile"
    }

    # postfix master.cf
    postconf -M | cat "$static/mastercfhead.txt" - > master.cf.old
    postconf -M -c "$srcdir" | cat "$static/mastercfhead.txt" - > master.cf.new
    if ! md5cmp master.cf.old master.cf.new ; then
        make_file_actions master.cf.old master.cf.new /etc/postfix/master.cf postfix_master
    fi

    # postfix files
    "$helpers/filesdir_diff" "postfix_files" "$srcdir/files" "$confdir" .

    if is_dovecot; then
        # dovecot.conf
        if ! md5cmp "$srcdir/dovecot.conf" /etc/dovecot/dovecot.conf ; then
            cp "$srcdir/dovecot.conf" dovecot.conf.new
            cp /etc/dovecot/dovecot.conf dovecot.conf.old
            make_file_actions dovecot.conf.old dovecot.conf.new /etc/dovecot/dovecot.conf dovecot_dot_conf
        fi
        # dovecot/conf.d files
        "$helpers/filesdir_diff" "dovecot_confd_files" "$srcdir/dovecot" /etc/dovecot/conf.d .
    fi

    # SPF
    if is_spf ; then
        if ! md5cmp "$srcdir/policyd-spf.conf" /etc/postfix-policyd-spf-python/policyd-spf.conf ; then
            cp "$srcdir/policyd-spf.conf" policyd-spf.conf.new
            cp /etc/postfix-policyd-spf-python/policyd-spf.conf policyd-spf.conf.old
            make_file_actions policyd-spf.conf.old policyd-spf.conf.new \
                /etc/postfix-policyd-spf-python/policyd-spf.conf policy_spf_conf
        fi
    fi

    # SPF
    local srsdchange=0
    if is_srsd ; then
        if ! md5cmp "$srcdir/postsrsd.conf" /etc/default/postsrsd ; then
            srsdchange=1
            cp "$srcdir/postsrsd.conf" postsrsd.conf.new
            cp /etc/default/postsrsd postsrsd.conf.old
            make_file_actions postsrsd.conf.old postsrsd.conf.new /etc/default/postsrsd postsrsd_conf
        fi
    fi
    popdq

    find "$outdir" -type f -print0 | xargs -0 chmod 0644
    local applyfiles
    readarray -t applyfiles < <(ls "$builddir/"*.apply.sh 2>/dev/null)
    if [[ "${#applyfiles[@]}" = 0 ]]; then
        echo "No configuration changes"
        rm -r "$outdir"
    else
        echo "Building change script"
        local applyfile="$outdir/apply.sh"
        local revertfile="$outdir/revert.sh"
        local header="$(printf "#!/bin/bash\n# $(date)\n# --------------")"
        echo -e "$header\n" | teeq -a "$applyfile" "$revertfile"
        local fa
        local fr
        for fa in "${applyfiles[@]}" ; do
            local fr="$(sed 's/\.apply\.sh$/\.revert\.sh/' <<< "$fa")"
            local ftitle="$(basename $fa | sed 's/\..*//')"
            echo " > $ftitle"
            echo "# $ftitle" >> "$applyfile"| teeq -a "$applyfile" "$revertfile"
            cat "$fa" >> "$applyfile"
            if [[ -e "$fr" ]]; then
                cat "$fr" >> "$revertfile"
            else
                echo "# no revert action" >> "$revertfile"
            fi
            echo "" | teeq -a "$applyfile" "$revertfile"
            rm -f "$fa" "$fr"
        done
        echo "Running change script"
        bash "$applyfile"
        echo "Marking as latest"
        pushdq "$outdir/.."
        rm -f latest
        ln -s "$(basename "$outdir")" latest
        popdq
    fi

    echo "Updating postmaps"
    "$helpers/postmaps_update" "$confdir"

    postfix_reload
    dovecot_reload
    if [[ "$srsdchange" = 1 ]]; then
        service_stop postsrsd
        service_start postsrsd
    fi
}

run